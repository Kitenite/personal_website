{"version":3,"file":"static/webpack/static/development/pages/projects/digit_recognizer.js.471571fc5c410e3a5249.hot-update.js","sources":["webpack:///./pages/projects/components/DrawingCanvas.js"],"sourcesContent":["import {useState, useRef, useEffect} from 'react';\nimport SignatureCanvas from 'react-signature-canvas'\nimport Button from '../../../components/Button';\n\n\nexport default function DrawingCanvas(){\n  // useStates\n  const sigCanvas = useRef({});\n  const [imageURL, setImageURL] = useState(null);\n  const [resultArray, setResultArray] = useState(null);\n  const [height, setHeight] = useState(null)\n  const [width, setWidth] = useState(null)\n  // Canvas Configuration\n\n  if (process.browser) {\n    useEffect(() => setHeight(document.children[0].clientHeight), [document.children[0].clientHeight])\n    useEffect(() => setWidth(document.children[0].clientWidth), [document.children[0].clientWidth])\n  }\n  const canvasWidth =  Math.min(height, width)/2;\n  const brushSize = (canvasWidth/30).toString(10);\n\n  // Functions\n  const clearPad = () => {\n    sigCanvas.current.clear();\n    setImageURL(null);\n    setResultArray(null);\n  };\n  const submitPad = () => {\n    let submittedImage = sigCanvas.current.getTrimmedCanvas();\n    let result = processImage(submittedImage)\n    apiCall(result[1]);\n    setImageURL(result[0].toDataURL(\"image/png\"));\n  };\n\n  // Query our AI model\n  const apiCall = (image_array) => {\n    const model_url = '/api/v1/models/digit_model:predict';\n    var xhr = new XMLHttpRequest();\n    xhr.withCredentials = false;\n    // get a callback when the server responds\n    xhr.addEventListener('load', () => {\n      // Get results and process\n      if (xhr.responseText){\n        let reponse = JSON.parse(xhr.responseText);\n        processResult(reponse)\n      }\n    });\n    xhr.open('POST', model_url);\n    xhr.send(JSON.stringify({ \"instances\": image_array }));\n  }\n\n  const processResult = (reponse) => {\n    let unsorted_array = reponse[\"predictions\"][0];\n    let sorted_array = Array(unsorted_array.length);\n    // Get all results above 0.00%\n    for (var i = 0; i< unsorted_array.length; i++){\n      let index = unsorted_array.indexOf(Math.max(...unsorted_array));\n      let confidence = (unsorted_array[index]*100).toFixed(2)\n      if (confidence > 0){\n        sorted_array[i] = [index, confidence];\n        unsorted_array[index] = 0;\n      }\n    }\n    setResultArray(sorted_array);\n  }\n  const processImage = (img) => {\n    // Scale image\n    const canvas =document.createElement('canvas');\n    const scale = Math.min(20/img.width, 20/img.height);\n    canvas.width = 28;\n    canvas.height = 28;\n    const cctx = canvas.getContext('2d');\n    cctx.imageSmoothingEnabled = true;\n    const scaled_width = img.width*scale;\n    const scaled_height = img.height*scale;\n    const dx = (28 - scaled_width)/2;\n    const dy = (28 - scaled_height)/2;\n    cctx.drawImage(img, dx, dy, scaled_width, scaled_height);\n\n\n    // Turn into 2D array of 28x28\n    const image_array = Array(28);\n    var column_count = 0\n    var row_count = 0\n    var column_array = Array(28);\n\n    // invert colors, make black and white and remove alpha\n    var imgData = cctx.getImageData(0, 0, canvas.width, canvas.height);\n    var i;\n    for (i = 0; i < imgData.data.length; i += 4) {\n\n      // Fill array\n      if (column_count >= 28){\n        column_count = 0;\n        image_array[row_count] = column_array;\n        // Reset column_array\n        column_array = Array(28);\n        row_count++;\n      }\n\n      if (imgData.data[i + 3] > 0){\n        // Used to visualize image for debugging, can be discarded\n        imgData.data[i] = 255;\n        imgData.data[i+1] = 255;\n        imgData.data[i+2] = 255;\n        // Convert to either 0 or 1\n        column_array[column_count] = 1;\n      } else {\n        // Used to visualize image for debugging, can be discarded\n        imgData.data[i] = 0;\n        imgData.data[i+1] = 0;\n        imgData.data[i+2] = 0;\n        // Convert to either 0 or 1\n        column_array[column_count] = 0;\n      }\n      imgData.data[i + 3] = 255;\n      column_count++;\n    }\n\n    // Lazy add final row empty\n    var final_row = Array(28);\n    for (var i =0; i< final_row.length; i++){\n      final_row[i] = 0;\n    }\n    image_array[27] = final_row;\n\n    // Print out array\n    // console.log(image_array);\n\n    cctx.putImageData(imgData, 0, 0);\n    let newImage = canvas;\n    return [newImage, image_array];\n  }\n\n  const result_graph = (resultArray) => {\n    return(<div>\n      {resultArray.map((result, index) => (\n        <p key={index}>Number: {result[0]} <br/>Confidence: {result[1]}%</p>\n    ))}\n    </div>\n    )\n  }\n\n  return(\n    <div>\n      <SignatureCanvas\n            ref = {sigCanvas}\n            penColor='black'\n            velocityFilterWeight='0'\n            maxWidth= {brushSize}\n            dotSize='0'\n            canvasProps={{\n              width: canvasWidth,\n              height: canvasWidth,\n              className: 'signatureCanvas'\n            }} />\n      <div className=\"button-wrapper\">\n        <Button onClick={clearPad} isClear=\"true\">clear</Button>\n        <Button onClick={submitPad}>submit</Button>\n        <style jsx>{`\n          padding-left:5vh\n          `}</style>\n      </div>\n      {resultArray ? (\n        <>\n          <a>Your result: </a>\n          <a>{result_graph(resultArray)}</a>\n        </>\n      ) : null}\n\n      {imageURL ? (\n        <>\n          <a>Processed Digit</a>\n          <img\n            src={imageURL}\n            alt=\"my signature\"\n            style={{\n              display: \"block\",\n              margin: \"0 auto\",\n              border: \"1px solid black\",\n              width: \"150px\"\n            }}\n          />\n        </>\n      ) : null}\n    </div>\n  )\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AAGA;AACA;AACA;AACA;AAHA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AACA;AAOA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AADA;AAKA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;AANA;AAWA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAFA;AAAA;AAkBA;AACA;AACA;AACA;AACA;AACA;AACA;AAJA;AAHA;AAcA;;;;A","sourceRoot":""}